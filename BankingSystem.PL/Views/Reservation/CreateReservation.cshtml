@using BankingSystem.DAL.Models
@model BankingSystem.PL.ViewModels.Customer.ReservationViewModel

@{
    ViewData["Title"] = "Create Reservation";
}

<h2>Create Reservation</h2>

<div asp-validation-summary="All" class="text-danger"></div>

@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success">
        @Html.Raw(TempData["SuccessMessage"])
    </div>
}


@* @if (TempData["ErrorMessage"] != null) *@
@* { *@
@*     <div class="alert alert-danger"> *@
@*         @TempData["ErrorMessage"] *@
@*     </div> *@
@* } *@

<div class="card shadow-lg p-4">
    <div class="row">
        <div class="col-md-6">
            <form asp-action="CreateReservation" method="post">
                <div class="form-group">
                    <label asp-for="BranchId">Select Branch:</label>
                    <select asp-for="BranchId" class="form-control" asp-items="@(new SelectList(ViewBag.Branches, "Id", "Name"))" required>
                        <option value="">Select Branch</option>
                    </select>
                </div>

                <div class="form-group">
                    <label asp-for="ReservationDate">Reservation Date:</label>
                    <input asp-for="ReservationDate" class="form-control" type="datetime-local" required />
                </div>

                @if (User.FindFirst(ClaimTypes.NameIdentifier)?.Value == null)
                {
                    <div class="form-group">
                        <label asp-for="ServiceType">Service Type:</label>
                        <select asp-for="ServiceType" class="form-control" required>
                            <option value="">Select Type</option>
                            <option value="OpenAccount">Open Account</option>
                        </select>
                    </div>
                }
                else
                {
                    <div class="form-group">
                        <label asp-for="ServiceType">Service Type:</label>
                        <select asp-for="ServiceType" asp-items="@Html.GetEnumSelectList<ServiceType>()" class="form-control" required>
                            <option value="">Select Type</option>
                        </select>
                    </div>
                }

                <div class="form-group">
                    <label asp-for="Notes">Notes:</label>
                    <textarea asp-for="Notes" class="form-control"></textarea>
                </div>
                <br />
                <button type="submit" class="btn btn-primary w-100">Book Reservation</button>
            </form>
        </div>

        <div class="col-md-6">
            <h3 class="text-center mb-4">Select Branch on Map</h3>
            <div id="map" style="height: 250px; width: 100%;"></div>
        </div>
    </div>
</div>

<script>
    var locations = @Html.Raw(Json.Serialize(ViewBag.Locations));

    function initMap() {
        var mapOptions = {
            center: { lat: 30.0444, lng: 31.2357 },
            zoom: 6
        };

        var map = new google.maps.Map(document.getElementById("map"), mapOptions);

        locations.forEach(function(location) {
            var marker = new google.maps.Marker({
                position: { lat: parseFloat(location.lat), lng: parseFloat(location.lng) },
                map: map,
                title: location.title,
                branchId: location.branchId,
                branchName: location.branchName
            });

            google.maps.event.addListener(marker, 'click', function() {
                selectedBranchId = marker.branchId;
                document.getElementById("BranchId").value = selectedBranchId;
            });
        });
    }
</script>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyALQ3AwOodSeIwxN1QdbtbHlIJpe7iobEo&callback=initMap" async defer></script>
